== README

rake db:create
mysql -u root helperchat_development < ./db/mysql.sql
rake db:migrate
rake db:seed

== Ejabberd
mod_archive_webview.beam
mod_archive_odbc.beam
mod_webpresence.beam
mysql.app
mysql_auth.beam
mysql.beam
mysql_conn.beam
mysql_recv.beam


-- mod_archive
Info = ejabberd_sm:get_user_info(User, Server, Resource),
{ip, {Ip, Port}} = lists:keyfind(ip, 1, Info).


get_client_ip(User, Server, Resource) ->
    [_Node, {conn, _Conn}, IP] = ejabberd_sm:get_user_info(User, Server, Resource),
    IP.


===================================================================
--- src/mod_archive_odbc.erl	(revision 1138)
+++ src/mod_archive_odbc.erl	(working copy)
@@ -1223,6 +1223,7 @@
     SUS = get_us_escaped({LUser, LServer}),
     SJID = get_jid_escaped(JID),
     {SUser, SServer, SResource} = SJID,
+    [_Node, {conn, _Conn}, RIP] = ejabberd_sm:get_user_info(LUser, LServer, JID),
     SUTC = encode_timestamp(Start),
     case get_collection_id_raw(SUS, SJID, SUTC) of
 	%% Collection is present already - just return its ID
@@ -1231,12 +1232,13 @@
 	    %% Insert new collection.
             InsVals = [SUS, ",",
                        SUser, ",",
+                       RIP, ",",
                        SServer, ",",
                        SResource, ",",
                        SUTC, ",",
                        "0"],
             run_sql_query(["insert into archive_collections"
-                           "(us, with_user, with_server, with_resource, utc, deleted) "
+                           "(us, with_user, remote_ip, with_server, with_resource, utc, deleted) "
                            "values(", InsVals, ")"]),
             case get_last_inserted_id(LServer, "archive_collections") of
                 error -> get_collection_id_raw(SUS, SJID, SUTC);
